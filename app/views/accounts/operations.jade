extends ../layouts/default

block header
  link(rel='stylesheet', href='/css/datepicker.css')
  link(rel='stylesheet', href='/css/jquery.toolbars.css')

block content
  div.container
    div.row
      div.span3
        include ../accounts/navbar
      div.span9
        h2
          strong #{req.account.name}
          | : #{lingua.accountOperations}
        form(class="well form-inline", id="operation")
          label(for="name") #{lingua.operation.name}
          input(type="text",id="name", name="name", class="input-small") 
          label(for="amount") #{lingua.operation.amount}
          input(type="text",id="amount", name="amount", class="input-small") 
          label(for="type") #{lingua.operation.type}
          select(id="type", name="type")
            option(value="debit") #{lingua.operation.typeDebit}
            option(value="credit") #{lingua.operation.typeCredit}
          label(for="date") #{lingua.operation.date}
          div(class="input-append date", id="dp3", data-date="12/02/2012", data-date-format="dd/mm/yyyy")
            input(class="input-small", id="date", name="date", size="16", type="text", value="12/02/2012")
            span(class="add-on")
              i(class="icon-th")
          button(class="btn btn-primary",type="button", id="addOperation") #{lingua.add}
        div.fuelux
          table( id="MyGrid", class="table table-bordered datagrid")
            thead
              tr
                th(colspan="2")
                  span.datagrid-header-title Operations
                  div.datagrid-header-left
                  div.datagrid-header-right
                    div(class="input-append search")
                      input(type="text", class="input-medium", placeholder="Search")
                      button.btn
                        i.icon-search
            tfoot
              tr
                th
                  div.datagrid-footer-left( style="display:none;")
                    div.grid-controls
                      span
                        span.grid-start - 
                        span.grid-end of 
                        span.grid-count
                      select.grid-pagesize
                        option 10
                        option 20
                        option 50
                        option 100
                      span Per Page
                  div.datagrid-footer-right(style="display:none;")
                    div.grid-pager
                      button(class="btn grid-prevpage")
                        i.icon-chevron-left
                      span Page
                      div(class="input-append dropdown combobox")
                        input.span1(type="text")
                          button.btn( data-toggle="dropdown")
                            i.caret
                        ul.dropdown-menu
                      span of
                        span.grid-pages
                      button(class="btn grid-nextpage")
                        i.icon-chevron-right
        
        div(class='modal fade', id='delete-ope')
          form
            input(type="hidden", name="_method", value="DELETE")
            div.modal-header
              button.close(data-dismiss='modal')×
              h3 #{lingua.deleteAccount.title}

            div.modal-body
              p #{lingua.deleteAccount.description(req.account.name)}

            div.modal-footer
              input(id="testest", type="text")
              button(class='btn btn-error', data-dismiss='modal') #{lingua.close}
              button(type="button", id="delOperation", class='btn btn-danger') #{lingua.delete}


block pageScript
  script(src="/js/datasource.js", type="text/javascript")
  script(src="/js/bootstrap-datepicker.js", type="text/javascript")
  script(src="/js/moment.min.js", type="text/javascript")  
  script(src="/js/lang/fr.js", type="text/javascript")
  script(type="text/javascript")
    $(document).ready(function() {
      //ajax sending for adding an operation
      $('#addOperation').click(function() {
          var jsonOp = JSON.stringify($("#operation").serializeObject());
          console.log(jsonOp);
          //console.log($('#operation').serialize());
          $.ajax({
              url: '/users/'+!{JSON.stringify(req.user.id)}+'/accounts/'+!{JSON.stringify(req.account.id)}+'/operation/',
              type: "POST",
              contentType: "application/json",
              data: jsonOp,
              success: function (result) {
                $('#MyGrid').datagrid('reload');
              },
              error: function (result, e) {
                console.log(result);
                alert(result + " : "+ e);
              }
          });  
      });
      
      //ajax sending for adding an operation
      $('#delOperation').click(function() {
          var jsonOp = JSON.stringify($("#operation").serializeObject());
          console.log(jsonOp);
          //console.log($('#operation').serialize());
          $.ajax({
              url: '/users/'+!{JSON.stringify(req.user.id)}+'/accounts/'+!{JSON.stringify(req.account.id)}+'/operation/'+$('#testest').val(),
              type: "DELETE",
              contentType: "application/json",
              data: jsonOp,
              success: function (result) {
                $('#MyGrid').datagrid('reload');
                $('#delete-ope').modal('hide');
              },
              error: function (result, e) {
                console.log(result);
                alert(result + " : "+ e);
              }
          });  
      });
    
      $('#dp3').datepicker({format:'dd/mm/yyyy'}).datepicker('setValue', new Date());
      $('#MyGrid').datagrid({
        dataSource: new FlickrDataSource({
          
          url : '/users/'+!{JSON.stringify(req.user.id)}+'/accounts/'+!{JSON.stringify(req.account.id)}+'/operationList',
          
          // Column definitions for Datagrid
          columns: [{
            property: 'name',
            label: !{JSON.stringify(lingua.operation.name)},
            sortable: true
          },{
            property: 'amount',
            label: !{JSON.stringify(lingua.operation.amount)},
            sortable: true
          },{
            property: 'type',
            label: !{JSON.stringify(lingua.operation.type)},
            sortable: true
          },{
            property: 'date',
            label: !{JSON.stringify(lingua.operation.date)},
            sortable: true
          },{
            property: '_id',
            label: !{JSON.stringify(lingua.action)},
            sortable: true
          }],
          
          // Create IMG tag for each returned image
          formatter: function (items) {
            moment.lang('fr');
            $.each(items, function (index, item) {
              //add operations colors
              
              //date formating
              item.date = moment(item.date, "YYYY-MM-DDTHH:mm:ss.SSSZ").format('LL');
              //action buttons adding
              var id = item._id;
              var actions = '<div class="btn-group"><button type="button" class="btn" id="removeope_'+id+'" ope-id="'+id+'"><i class="icon-trash"></i></button><button type="button" class="btn" id="editope_'+id+'" ope-id="'+id+'"><i class="icon-pencil"></i></button></div>';
              item._id = actions;
            });
          }
        })
      }).on('loaded', function () {
        //var toolbar;
        $("button[id^='removeope_']").on('click', function(e){
          e.preventDefault();
          //console.log($(this).attr("ope-id"));
          //toolbar = '<div class="btn-group btn-group-vertical"><button type="button" class="btn"><i class="icon-align-left"></i></button><button type="button" class="btn"><i class="icon-align-center"></i></button></div>';
          $("#testest").val($(this).attr("ope-id")); 
          $('#delete-ope').modal('show');
        });
       
      });    
    
    
    });
    